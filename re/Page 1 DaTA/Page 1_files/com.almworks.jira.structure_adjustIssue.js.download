/* module-key = 'com.almworks.jira.structure:adjustIssue', location = 'js/structure/adjustIssue.js' */
(function(v){function L(){function s(){var i=e("#s-helper-panel-content");if(i.length){j=f.toIntSafe(i.attr("data-issue-id"),0);q=i.attr("data-issue-key")||"";t.setValue(i.attr("data-show-structure")==="true");if(t.value()){if(j){var m=i.attr("data-unstructured")==="true";i=i.attr("data-auto-collapsed")==="true";w.helperPanelChanged(i,m)}}else{w.hideModule(true);y.restoreJiraTimetrackingModule()}}}p.modes.ISSUE_PAGE=true;var j=0,q="",t=new f.Cell(false),y=new H(t,function(){return{issue:j,structure:w.getSelectedStructureId()}}),
w=new function(){function i(a){h=e(f.renderTemplate('<div id="structuremodule" class="module toggle-wrap"><div class="mod-header"><ul class="s-ops"><li class="s-hide-if-collapsed"><a href="#" id="s-view-dd-trigger" class="s-view"></a><div id="s-view-dd-container"></div></li><li><a href="#" id="s-uioptions" class="s-atlas-cog" style="display: none" title="{s.w.uisettings.tooltip}"><span>{s.w.uisettings.title}</span></a></li></ul><h3 class="toggle-title">{s.iv.module.title}</h3><span id="structuremodule-selector"></span><span id="unstructured-warning"></span></div><div id="structuremodule-content" class="mod-content"><div id="structure"></div></div></div>')).insertBefore(a);
b=new p.StructureSelector({selectorSpan:h.find("#structuremodule-selector"),titleSpan:h.find("h3"),forIssue:j,selectorClasses:"hideCollapsed",configTrigger:h.find("#s-uioptions")});b.getSelectedStructureCell().pipeChanges(function(){y.loadTimeTracking()});e(".mod-header h3",h).click(function(){v.setTimeout(m,10)});b.getIssueUnstructuredCell().pipeChanges(function(c){h.toggleClass("s-unstructured",c)});b.getAutoCollapsedCell().pipeChanges(function(c){if(c!==null){c=I("#structuremodule")||c;f.updateClasses(h,
c?["collapsed"]:["expanded"],["collapsed","expanded"]);m()}});y.trackTimetrackingUpdates();o();u()}function m(){h.is(".collapsed")||(d===null?k():d.forceLayout())}function k(){d=new p.StructureWidget(e("#structure"),{tableConfigKey:"issue",height:"model",maxHeight:300,hideable:true,anchorIssue:j});d.setInitiallySelectedIssueFromLocation(j);d.setFixedViewTargetIssueOverride(j);b.setWidget(d);y.trackStructureUpdates(d.eventBus);d.eventBus.addListener(new f.Life,C.ERROR_HAPPENED,function(){t.value()||
d.errorCentral.dismissAllErrors()});d.getFixedViewRootPathCell().pipeChanges(function(a){b.getIssueUnstructuredCell().setValue(!!(a&&!a.length))});e(z);e(x)}function o(){var a=namespace("JIRA.Dialogs.editLabels",false);if(a){var c=a.labelsProvider;if(typeof c==="function")a.labelsProvider=function(g){var l=g.$activeTrigger;if(l&&l.parents("#structuremodule").length)if((l=f.toIntSafe(l.attr("data-issueId")))&&j&&j!==l)return e();return c.apply(this,arguments)}}}function z(){function a(n,D){if(D)try{var A,
J,K,B=false;if(n===j)B=true;if(!B){A=e("#linkingmodule");if(A.length){K=/^internal-(\d+)_/;A.find("dd[id]").each(function(){var F=e(this).attr("id");if((F=K.exec(F))&&f.toIntSafe(F[1])===n){B=true;return false}})}}if(!B&&c&&typeof c.getSubtaskModule==="function")if((A=c.getSubtaskModule())&&typeof A.find==="function")if((J=A.find("tr.issuerow[rel="+n+"]"))&&J.length)B=true;B&&l.trigger(g.REFRESH_ISSUE_PAGE,[j])}catch(M){f.warn("problem refreshing issue",M)}}var c=namespace("JIRA.Issue",false),g=namespace("JIRA.Events",
false),l=namespace("JIRA",false),r;if(d&&g&&g.REFRESH_ISSUE_PAGE&&typeof l.trigger==="function"){r={};r[C.EDIT_UPLOAD_FINISHED]=a;d.eventBus.addListener(new f.Life,r)}}function u(){var a=namespace("JIRA.Issue",false),c=namespace("JIRA.Dialog",false),g=a&&a.getIssueId,l=a&&a.refreshSubtasks,r=c&&c.getAttrFromActiveTrigger;if(typeof g==="function"&&typeof r==="function"){a.getIssueId=function(){return c.current&&r("data-issueId")||g()};if(typeof l==="function")a.refreshSubtasks=function(){if(a.getIssueId()===
g())return l();return{done:function(n){typeof n==="function"&&n()}}}}}function x(){var a=f.delayed(100,function(){f.onPage(h)&&d.forceLayout()});G.$("body").on("drag",".navigator-content .split-view",a)}var h=null,d=null,b=null;f.extend(this,{helperPanelChanged:function(a,c){if(!h||!f.onPage(h)){var g;g=e("#activitymodule");if(!g.length){g=e("#addcomment");g.length||(g=e("#primary .content > div:last"))}g=g.length?g:null;if(!g){f.warn("nowhere to add structure module");return}if(h){h.detach().insertBefore(g).show();
b.reinitialize(j);b.reinitializeSettings();if(d){d.reinstallAJSMouseHandler();d.updateAnchorIssue(j,true,true);p.reviveHelpPanels(d);d.reviveIssueActionDropDowns();d.forceLayout()}}else i(g);h.find("#unstructured-warning").text(f.text("s.w.iv.unstructured.warning",q)).attr("title",f.text("s.w.iv.unstructured.description",q))}if(b){b.getIssueUnstructuredCell().setValue(c);b.getAutoCollapsedCell().setValue(a)}},hideModule:function(a){if(h){h.detach();a&&d&&d.errorCentral.dismissAllErrors()}},getSelectedStructureId:function(){if(d)return d.getStructureId();
var a=b&&b.getSelectedStructureCell();return(a=a&&a.value())&&a.id}})};s();(function(){var i=v.JIRA;!i||typeof i.bind!=="function"||!i.Events||!i.Events.NEW_CONTENT_ADDED||i.bind(i.Events.NEW_CONTENT_ADDED,function(m,k,o){if(o==="pageLoad"||o==="panelRefreshed"&&k&&typeof k!=="function"&&e(k).attr("id")==="structure-helper-panel")s()})})();(function(){if(e.browser&&e.browser.msie){if(E&&E.Issues&&E.Issues.Application)try{E.Issues.Application.request("issueEditor").model.on("updated",function(u){u.initialize&&
w.hideModule(false)})}catch(i){f.warn("Could not install IE workaround for HJ-2110",i)}try{var m=namespace("JIRA.Issues.IssueNavCreator.searchPageModule.search",false),k=m&&m.getResults&&m.getResults(),o=k&&k.getSelectedIssue&&k.getSelectedIssue();if(o)o.on("change:id",function(){var u=m.isStandAloneIssue&&m.isStandAloneIssue(),x=k.hasSelectedIssue&&k.hasSelectedIssue();!u&&!x&&w.hideModule(false)})}catch(z){f.warn("Could not install IE workaround for HJ-2139",z)}}})()}function I(s){var j=v.localStorage;
if(j)try{var q=j.getItem("block-states");if(typeof q==="string")return!!q&&q.indexOf(s)>=0}catch(t){}return false}function H(s,j){function q(b){b.find("#tt_structure_table_info dt").text(function(a,c){return"\u03a3\u00a0"+e.trim(c)})}function t(b){var a=e("#timetrackingmodule");a.length||(a=e("#datesmodule"));a.length||(a=e("#peoplemodule"));a.length?b.insertAfter(a):b.appendTo("#viewissuesidebar")}function y(b){var a=e(b).find("#s-timetrackingmodule");q(a);var c=e("#timetrackingmodule");if(!d&&!a.length)c.show();
else{var g;b=null;if(c.length){b=c.find(".mod-content").html();g=c.find("#log-work-link").attr("href");c.hide()}c=false;if(d){var l=d.find("#tt_structure_table_info");if(l.length){var r=a.find("#tt_structure_table_info");if(r.length){g=a.find("#log-work-link").attr("href");l.html(r.html());c=true}}g&&d.find("#log-work-link").attr("href",g);f.onPage(d)||t(d)}else{f.assert(a.length);x||(x=a.find("#tt_info_non_structure").html());d=a;t(d);g=I("#s-timetrackingmodule");d.addClass(g?"collapsed":"expanded");
c=!!d.find("#tt_structure_table_info").length}g=b||x;var n=d.find("#tt_info_non_structure");if(n.html()!==g){n.html(g);e("#tt_include_subtasks input",n).click(function(){var D=e(this).is(":checked");e("#tt_info_single",n).toggle(!D);e("#tt_info_aggregate",n).toggle(D)})}f.Cell.prototype.multiUpdate(true);try{z.setValue(c);u.setValue(!!b)}finally{f.Cell.prototype.multiUpdate(false)}i();w(d)}}function w(b){var a=v.JIRA;if(!(!a||!a.trigger||!b||!b[0]))try{a.trigger(a.Events.NEW_CONTENT_ADDED,[G.$(b[0]),
"timeTrackingPanelUpdatedByStructure"])}catch(c){f.warn("caught exception when notifying about page change",c)}}function i(){if(o)o.setView(e("#cb_tt_use_structure"));else{k.setValue(p.getStored("issue-tt-use-structure")!=="false");o=new f.CheckboxPresenter(k,e("#cb_tt_use_structure"));k.pipeChanges(function(b){p.setStored("issue-tt-use-structure",b?"true":"false")});(new f.Cell(u,z,k,function(b,a,c){if(a)return c?3:2;if(b)return 1;return 0})).pipe(function(b){d&&d.toggle(b!==0);if(b!==0){e("#tt_use_structure").toggle(b!==
1);e("#tt_info_structure").toggle(b===3);e("#tt_info_non_structure").toggle(b!==3)}})}}function m(){var b=j();if(!(!b.issue||!b.structure||f.deepEquals(b,h))){h=b;var a=false;e.ajax({url:p.ajsbridge.localURL(f.renderTemplate("/secure/StructureTimeTrackingSection.jspa?id={issue}&structure={structure}&decorator=none",b)),cache:false,dataType:"html",success:function(c){a=true;h===b&&s.value()&&y(c)},complete:function(){if(h===b){h=null;if(!a&&s.value()){f.warn("did not receive reply from STTS");var c=
e("#s-timetrackingmodule");c.length?c.show():e("#timetrackingmodule").show()}}}})}}var k=new f.Cell(true),o=null,z=new f.Cell(false),u=new f.Cell(false),x="",h=null,d=null;f.extend(this,{restoreJiraTimetrackingModule:function(){e("#s-timetrackingmodule").hide();e("#timetrackingmodule").show()},trackTimetrackingUpdates:function(){var b=v.JIRA;!b||typeof b.bind!=="function"||!b.Events||!b.Events.ISSUE_REFRESHED||b.bind(b.Events.ISSUE_REFRESHED,function(){if(s.value())try{d&&e("#timetrackingmodule").hide();
m()}catch(a){f.warn("problem processing time tracking update",a)}})},trackStructureUpdates:function(b){b.addListener(new f.Life,new function(){function a(){for(var c=j().issue,g=0,l=arguments.length;g<l;g++)if(arguments[g]==="all"||f.indexOf(arguments[g],c)>=0){m();break}}this[C.POLL_FINISHED]=a;this[C.UPLOAD_FINISHED]=a})},loadTimeTracking:m})}var f=namespace("almworks.util",false),p=namespace("almworks.structure",false),C=namespace("almworks.structure.appevents"),G=v.AJS;if(!(!p||!f||!G)){var e=
p.$,E=v.JIRA;e(function(){if(e("#structure").length)p.IssuePageTimeTrackingController=H;else L()})}})(window);

